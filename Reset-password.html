<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset password</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#071125;color:#e6eef8}
    .card{width:380px;padding:28px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.2));box-shadow:0 6px 30px rgba(2,6,23,0.6)}
    label{display:block;margin-bottom:8px;font-size:13px}
    input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:inherit;margin-bottom:12px}
    button{padding:10px 14px;border-radius:10px;border:0;background:linear-gradient(90deg,#7b5cff,#9d64ff);color:white;width:100%;font-weight:600}
    .msg{padding:10px;border-radius:8px;margin-bottom:12px;font-size:14px}
    .error{background:#3a0f12;color:#ffd6d6}
    .ok{background:#08321a;color:#bff5c7}
    .small{font-size:13px;opacity:0.85}
    a{color:#9d64ff}
  </style>
</head>
<body>
  <div class="card">
    <h2>Reset password</h2>
    <div id="notice" class="msg small" style="display:none;"></div>

    <label for="pw">New password</label>
    <input id="pw" type="password" placeholder="Enter new password" minlength="8" />

    <label for="pw2">Confirm password</label>
    <input id="pw2" type="password" placeholder="Confirm password" minlength="8" />

    <button id="submit">Save new password</button>
    <div id="done" class="msg ok" style="display:none;margin-top:12px">Password changed. Redirecting to login...</div>
    <div style="margin-top:10px" class="small">If link expired request another reset from the <a href="/">login page</a>.</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script>
    // === CONFIGURE THESE ===
    const SUPABASE_URL = 'https://vdbjltfyoxmiijuwjlur.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYmpsdGZ5b3htaWlqdXdqbHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTA5MDcsImV4cCI6MjA2ODQ4NjkwN30.rSHfuHf2VcpEua__z2GXipSHVs_3gWSayfswIOyNL9E';
    // =======================

    const params = new URLSearchParams(location.search);
    // Supabase recovery links typically include 'access_token' and 'type=recovery'
    const token = params.get('access_token') || params.get('token');

    const notice = document.getElementById('notice');
    const pw = document.getElementById('pw');
    const pw2 = document.getElementById('pw2');
    const submit = document.getElementById('submit');
    const done = document.getElementById('done');

    if (!token) {
      notice.style.display = 'block';
      notice.className = 'msg error';
      notice.textContent = 'Invalid or expired reset link. Request a new reset email.';
      submit.disabled = true;
    }

    const supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    async function setSessionFromToken(token) {
      // set session so updateUser works
      try {
        const { error } = await supabase.auth.setSession({ access_token: token, refresh_token: '' });
        if (error) throw error;
        return true;
      } catch (err) {
        notice.style.display = 'block';
        notice.className = 'msg error';
        notice.textContent = 'Could not establish session from link. ' + (err.message || err);
        submit.disabled = true;
        return false;
      }
    }

    submit.addEventListener('click', async () => {
      if (pw.value.length < 8) {
        notice.style.display = 'block';
        notice.className = 'msg error';
        notice.textContent = 'Password must be at least 8 characters.';
        return;
      }
      if (pw.value !== pw2.value) {
        notice.style.display = 'block';
        notice.className = 'msg error';
        notice.textContent = 'Passwords do not match.';
        return;
      }

      notice.style.display = 'none';
      submit.disabled = true;
      submit.textContent = 'Saving...';

      const ok = await setSessionFromToken(token);
      if (!ok) return;

      // update password
      try {
        const { data, error } = await supabase.auth.updateUser({ password: pw.value });
        if (error) throw error;
        done.style.display = 'block';
        setTimeout(() => { location.href = '/login' }, 1400);
      } catch (err) {
        submit.disabled = false;
        submit.textContent = 'Save new password';
        notice.style.display = 'block';
        notice.className = 'msg error';
        notice.textContent = 'Failed to update password. ' + (err.message || err);
      }
    });
  </script>
</body>
</html>
