<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Dashboard — NovaMind</title>
  <link rel="stylesheet" href="css/style.css">
  <style>
    body{background:#071226;color:#dbe6f3;font-family:Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .dash-wrap{display:flex;min-height:100vh}
    .sidebar{width:220px;background:#071827;padding:24px;color:#9fb2c8}
    .brand{width:56px;margin-bottom:18px}
    .menu a{display:block;color:inherit;margin:10px 0;text-decoration:none}
    .dash-main{flex:1;padding:20px}
    .dash-header h1{font-size:28px;margin:0}
    .cards{display:grid;grid-template-columns:1fr 340px;gap:18px;margin-top:18px}
    .card{background:#071826;border-radius:10px;padding:16px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .tools-list{list-style:none;padding:0;margin:0}
    .tools-list li{display:flex;align-items:center;justify-content:space-between;padding:10px 8px;border-bottom:1px solid rgba(255,255,255,0.02)}
    .badge{padding:6px 10px;border-radius:999px;font-size:12px}
    .up{background:#0b6b2b;color:#dff6e6}
    .down{background:#6b1111;color:#ffe6e6}
    .coming{background:#444;color:#fff}
    .small{font-size:12px;color:#9fb2c8}
  </style>
</head>
<body>
  <div class="dash-wrap">
    <aside class="sidebar">
      <img src="assets/logo.png" class="brand" alt="logo">
      <nav class="menu">
        <a href="#" class="active">Overview</a>
        <a href="plans.html">Tools</a>
        <a href="settings.html">Settings</a>
        <a id="signout" href="#">Sign out</a>
      </nav>
      <div class="small" style="margin-top:22px">UID: <span id="uidSmall">—</span></div>
    </aside>

    <main class="dash-main">
      <header class="dash-header">
        <div>
          <h1>Welcome, <span id="userEmail">—</span></h1>
          <div class="small" id="userMeta">Loading profile...</div>
        </div>
      </header>

      <section class="cards">
        <!-- Tools column -->
        <div class="card">
          <h3>Available tools</h3>
          <ul id="tools" class="tools-list"></ul>
        </div>

        <!-- Profile card -->
        <div class="card">
          <h3>Profile</h3>
          <div style="display:flex;gap:12px;align-items:center">
            <img id="avatar" src="assets/default-avatar.png" alt="avatar" style="width:56px;height:56px;border-radius:50%">
            <div>
              <div id="fullName"><strong>—</strong></div>
              <div class="small" id="emailSmall">—</div>
              <div class="small" id="providersSmall">—</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.min.js"></script>
  <script src="js/supabase-client.js"></script>

  <script>
    // tools definition
    const TOOLS = [
      { id: 'enhancer', name: 'Image Enhancer', url: 'https://novamind-imae-enhancer.onrender.com/', status: 'live' },
      { id: 'tool2', name: 'Tool 2', url: '#', status: 'coming' },
      { id: 'tool3', name: 'Tool 3', url: '#', status: 'coming' }
    ];

    function makeToolRow(tool){
      const li = document.createElement('li');
      li.id = 'row-' + tool.id;
      const left = document.createElement('div');
      if(tool.status === 'live'){
        left.innerHTML = `<a href="${tool.url}" target="_blank"><strong>${tool.name}</strong></a>`;
      } else {
        left.innerHTML = `<strong>${tool.name}</strong>`;
      }
      const right = document.createElement('div');
      if(tool.status === 'live'){
        right.innerHTML = `<span class="badge up">Available</span>`;
      } else {
        right.innerHTML = `<span class="badge coming">Coming soon</span>`;
      }
      li.appendChild(left);
      li.appendChild(right);
      return li;
    }

    function initTools(){
      const container = document.getElementById('tools');
      TOOLS.forEach(t => container.appendChild(makeToolRow(t)));
    }

    // handle OAuth redirect if landed directly
    async function handleOAuthReturnOnDashboard(){
      try {
        const { error } = await supabaseClient.auth.getSessionFromUrl({ storeSession: true });
        if(error) console.warn('getSessionFromUrl:', error.message);
        history.replaceState(null, '', window.location.pathname);
      } catch(e){ console.warn('getSessionFromUrl failed', e); }
    }

    (async function(){
      try {
        await handleOAuthReturnOnDashboard();

        const { data } = await supabaseClient.auth.getSession();
        const session = data?.session ?? null;
        if(!session){
          location.href = 'login.html';
          return;
        }

        const user = session.user;
        document.getElementById('userEmail').textContent = user.email || '—';
        document.getElementById('userMeta').textContent = `UID: ${user.id}`;
        document.getElementById('uidSmall').textContent = user.id;
        document.getElementById('avatar').src = user.user_metadata?.avatar_url || 'assets/default-avatar.png';
        document.getElementById('fullName').textContent = user.user_metadata?.full_name || '—';
        document.getElementById('emailSmall').textContent = user.email || '—';
        document.getElementById('providersSmall').textContent = (user.app_metadata?.providers || []).join(', ') || '—';

        document.getElementById('signout').addEventListener('click', async (e)=>{
          e.preventDefault();
          await supabaseClient.auth.signOut();
          location.href = 'login.html';
        });

        initTools();
      } catch(err){
        console.error('session error', err);
        location.href = 'login.html';
      }
    })();
  </script>
</body>
</html>
