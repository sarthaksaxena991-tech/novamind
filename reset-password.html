<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f5f7fa;margin:0}
    .card{width:360px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1{font-size:18px;margin:0 0 12px}
    label{display:block;font-size:13px;margin:8px 0 4px}
    input{width:100%;padding:10px;border:1px solid #d7dbe0;border-radius:6px;font-size:14px;box-sizing:border-box}
    button{margin-top:14px;width:100%;padding:10px;border:0;border-radius:8px;background:#0b69ff;color:#fff;font-weight:600;cursor:pointer}
    .msg{margin-top:12px;padding:10px;border-radius:6px;font-size:13px}
    .msg.error{background:#ffecec;color:#b00020}
    .msg.info{background:#eef6ff;color:#083d77}
    .tiny{font-size:12px;color:#666;margin-top:8px;text-align:center}
  </style>
  <script type="module">
    // Load supabase client (ES module). Replace keys below.
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // === CONFIGURE THESE ===
    const SUPABASE_URL = "https://vdbjltfyoxmiijuwjlur.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZkYmpsdGZ5b3htaWlqdXdqbHVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI5MTA5MDcsImV4cCI6MjA2ODQ4NjkwN30.rSHfuHf2VcpEua__z2GXipSHVs_3gWSayfswIOyNL9E";
    // ========================

    window.supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  </script>
</head>
<body>
  <div class="card" id="card">
    <h1>Reset your password</h1>

    <div id="notice" class="msg info" style="display:none"></div>

    <label for="pw">New password</label>
    <input id="pw" type="password" autocomplete="new-password" />

    <label for="pw2">Confirm password</label>
    <input id="pw2" type="password" autocomplete="new-password" />

    <button id="submit">Set new password</button>

    <div id="done" class="msg" style="display:none"></div>
    <div class="tiny">If the link expired request a new reset email from the forgot-password page.</div>
  </div>

  <script>
    // Wait until supabase is ready on window
    async function main() {
      const { createClient } = window.supabase ? null : null; // noop - supabase module already set on window in module script
      const supabase = window.supabase;

      const q = new URLSearchParams(window.location.search);
      // if provider returned token in hash (Supabase does), convert hash -> params
      const h = new URLSearchParams(window.location.hash.replace(/^#/,'?'));
      // Supabase commonly provides access_token in hash
      const access_token = h.get('access_token') || q.get('access_token') || q.get('token') || h.get('token');

      const notice = document.getElementById('notice');
      const pw = document.getElementById('pw');
      const pw2 = document.getElementById('pw2');
      const submit = document.getElementById('submit');
      const done = document.getElementById('done');

      function show(type, text) {
        notice.style.display = 'block';
        notice.className = 'msg ' + (type === 'error' ? 'error' : 'info');
        notice.textContent = text;
      }

      if (!access_token) {
        show('error', 'Missing reset token. Request a new reset email.');
        submit.disabled = true;
        return;
      }

      // Set session from token. Supabase SDK stores it client-side.
      // supabase.auth.setSession accepts object { access_token, refresh_token } in v1; if using newer SDK the method exists similarly.
      // We only have access_token from the link. Use setSession or setAuth depending on SDK version.
      try {
        // prefer setSession if available
        if (typeof supabase.auth.setSession === 'function') {
          // if refresh_token also present, include it
          const refresh = h.get('refresh_token') || q.get('refresh_token') || null;
          await supabase.auth.setSession({ access_token, refresh_token: refresh });
        } else if (typeof supabase.auth.setAuth === 'function') {
          // older fallback
          supabase.auth.setAuth(access_token);
        } else {
          // if none available, still continue: some SDK versions accept updateUser with `access_token` in headers server-side,
          // but common path is setSession above. If not present, we still try updateUser below; it will likely fail.
        }
      } catch (err) {
        console.error('set session error', err);
        show('error', 'Unable to initialize session from token. Try requesting a new reset email.');
        submit.disabled = true;
        return;
      }

      // remove token from URL to avoid leaking via referer
      try {
        const url = new URL(window.location.href);
        url.hash = '';
        url.search = '';
        window.history.replaceState({}, '', url.pathname + url.search + url.hash);
      } catch(e){}

      async function handleSubmit() {
        if (submit.disabled) return;
        const password = pw.value.trim();
        const password2 = pw2.value.trim();

        if (password.length < 8) {
          show('error', 'Password must be at least 8 characters.');
          return;
        }
        if (password !== password2) {
          show('error', 'Passwords do not match.');
          return;
        }

        submit.disabled = true;
        show('info', 'Setting password...');

        // Use provider SDK to update user password.
        // supabase.auth.updateUser requires an authenticated session.
        try {
          const { data, error } = await supabase.auth.updateUser({ password });
          if (error) {
            console.error('updateUser error', error);
            show('error', error.message || 'Failed to update password.');
            submit.disabled = false;
            return;
          }
          done.style.display = 'block';
          done.className = 'msg info';
          done.textContent = 'Password updated. Redirecting to login...';
          setTimeout(()=> window.location.href = '/login.html', 900);
        } catch (err) {
          console.error('update failed', err);
          show('error', 'Network or server error. Try again.');
          submit.disabled = false;
        }
      }

      submit.addEventListener('click', handleSubmit);
      [pw, pw2].forEach(el => el.addEventListener('keyup', e => { if (e.key === 'Enter') handleSubmit(); }));
    }

    // run main when supabase client loaded
    (function waitForSupabase() {
      if (window.supabase) return main();
      setTimeout(waitForSupabase, 50);
    })();
  </script>
</body>
</html>
