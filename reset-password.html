<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reset Password</title>
  <style>
    body{font-family:system-ui,Segoe UI,Roboto,Arial;display:flex;min-height:100vh;align-items:center;justify-content:center;background:#f5f7fa;margin:0}
    .card{width:360px;background:#fff;padding:20px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
    h1{font-size:18px;margin:0 0 12px}
    label{display:block;font-size:13px;margin:8px 0 4px}
    input{width:100%;padding:10px;border:1px solid #d7dbe0;border-radius:6px;font-size:14px;box-sizing:border-box}
    button{margin-top:14px;width:100%;padding:10px;border:0;border-radius:8px;background:#0b69ff;color:#fff;font-weight:600;cursor:pointer}
    .msg{margin-top:12px;padding:10px;border-radius:6px;font-size:13px}
    .msg.error{background:#ffecec;color:#b00020}
    .msg.info{background:#eef6ff;color:#083d77}
    .tiny{font-size:12px;color:#666;margin-top:8px;text-align:center}
  </style>
</head>
<body>
  <div class="card" id="card">
    <h1>Reset your password</h1>

    <div id="notice" class="msg info" style="display:none"></div>

    <label for="pw">New password</label>
    <input id="pw" type="password" autocomplete="new-password" />

    <label for="pw2">Confirm password</label>
    <input id="pw2" type="password" autocomplete="new-password" />

    <button id="submit">Set new password</button>

    <div id="done" class="msg" style="display:none"></div>
    <div class="tiny">If link expired request a new password reset from the forgot-password page.</div>
  </div>

  <script>
    // read token from query or hash (handles both cases)
    const q = new URLSearchParams(window.location.search);
    const h = new URLSearchParams(window.location.hash.replace(/^#/,'?'));
    const token = q.get('token') || q.get('access_token') || h.get('token') || h.get('access_token');

    const notice = document.getElementById('notice');
    const pw = document.getElementById('pw');
    const pw2 = document.getElementById('pw2');
    const submit = document.getElementById('submit');
    const done = document.getElementById('done');

    // token missing -> show error and disable submit
    if (!token) {
      notice.style.display = 'block';
      notice.className = 'msg error';
      notice.textContent = 'Invalid or missing reset token. Request a new reset email.';
      submit.disabled = true;
    } else {
      // store token for submit
      window.__resetToken = token;
      // optional: remove token from address bar to avoid leaking via referer
      try {
        const url = new URL(window.location.href);
        url.search = '';
        url.hash = '';
        window.history.replaceState({}, '', url.pathname + url.search + url.hash);
      } catch (e) { /* ignore */ }
    }

    function setNotice(text, type = 'info') {
      notice.style.display = 'block';
      notice.className = 'msg ' + (type === 'error' ? 'error' : 'info');
      notice.textContent = text;
    }

    async function handleSubmit() {
      if (submit.disabled) return;
      const password = pw.value.trim();
      const password2 = pw2.value.trim();

      if (password.length < 8) {
        setNotice('Password must be at least 8 characters.', 'error');
        return;
      }
      if (password !== password2) {
        setNotice('Passwords do not match.', 'error');
        return;
      }

      submit.disabled = true;
      setNotice('Sending...', 'info');

      try {
        const res = await fetch('/api/reset-password', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token: window.__resetToken, password })
        });

        if (res.ok) {
          // success
          done.style.display = 'block';
          done.className = 'msg info';
          done.textContent = 'Password reset successful. Redirecting...';
          setTimeout(()=> window.location.href = '/reset-success.html', 800);
          return;
        }

        // try to parse response body for message
        let payload;
        try { payload = await res.json(); } catch(e){ payload = null; }
        const err = payload && (payload.error || payload.message) ? (payload.error || payload.message) : `Request failed (${res.status})`;
        setNotice(err, 'error');
      } catch (err) {
        setNotice('Network error. Check server or try again.', 'error');
      } finally {
        submit.disabled = false;
      }
    }

    submit.addEventListener('click', handleSubmit);
    // allow enter key for convenience
    [pw, pw2].forEach(el => el.addEventListener('keyup', e => { if (e.key === 'Enter') handleSubmit(); }));
  </script>
</body>
</html>
